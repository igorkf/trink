{% extends 'base.html' %}

{% load static %}

{% block title %}
    Trink
{% endblock %}

{% block content %}
    <h1>Trink</h1>

    {% if user.is_authenticated %}  
        <h2>Encurtar link:</h2>
        <form action="{% url 'shortener' %}" method="post">
            <label for="nome">URL:</label>
            <input type="text" name='url_input'/>
                {% csrf_token %} {{ form.as_p }}
                <button type="submit" id="shorten-url">Encurtar link</button>
        </form>

        <h2>Links encurtados:</h2>
        <table id="links-table">
             <thead>
                <tr>
                    <th>URL</th>
                    <th>URL encurtada</th>
                    <th>Criada em</th>
                    <th>Expira em</th>
                </tr>
            </thead>
        </table>
        <p><a href="{% url 'logout' %}">Fazer logout</a></p>
        
    {% else %}
        <p>Você não está logado.</p>
        <a href="{% url 'login' %}">Fazer login</a>
        <br>
        <a href="{% url 'signup' %}">Criar uma conta</a>
    {% endif %}

    {% block javascript %}

    <script>
        {% comment %} $(function() {
            $("#shorten-url").click(function() {
                $.post(
                    url: '{% url "shortener" %}',
                    data: {'url': 'abcde'}
                    success: function(data, status, xhr) {
                       console.log(data)
                    }
                );
                return false;
            });
        }); {% endcomment %}

        $(function() {
            $.ajax({
                    url: '{% url "links" %}',
                    dataType: 'json',
                    type: 'get',
                    cache: false,
                    success: function(data) {
                        var event_data = '';
                        $.each(data.links, function(index, value) {                            
                            event_data += '<tr>';
                            event_data += '<td><a href="' + value.url + '">' + value.url + '</td>';
                            event_data += '<td><a href="' + '{% url "redirect" shortened_url=123 %}'.replace(/123/, value.shortened_url) + '">' + value.shortened_url + '</td>';
                            event_data += '<td>' + value.created_at.slice(0, -8) + '</td>';
                            event_data += '<td>' + value.expires_at.slice(0, -8) + '</td>';
                            event_data += '</tr>';
                        });
                        $("#links-table").append(event_data);
                    },
                    error: function(d) {
                    }
                });
            });
    </script>
    {% endblock javascript %}
{% endblock %}